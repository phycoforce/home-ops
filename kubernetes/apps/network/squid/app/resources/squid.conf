visible_hostname local-squid
http_port 3128

# In-memory small-object cache
cache_mem 256 MB

# On-disk persistent object cache (~9.5GiB of the 10Gi PVC), multi-level layout
cache_dir aufs /var/spool/squid 9500 16 256

### ── Disable ICMP pinger ───────────────────────────────
pinger_enable off

### ── Safe ports & CONNECT ───────────────────────────────
acl Safe_ports port 80 443 1025-65535
acl SSL_ports  port 443
acl CONNECT    method CONNECT

### ── Domains that must go through the VPS ───────────────
acl forward_list dstdom_regex -i ${DOMAINS}

# Forward these through the parent VPS proxy
cache_peer ${VPS_IP} parent 3128 0 no-query login=squidproxy:${VPS_PASSWORD}
cache_peer_access ${VPS_IP} allow forward_list
cache_peer_access ${VPS_IP} deny all

# Prevent direct access to forward_list domains
never_direct allow forward_list
always_direct deny forward_list

### ── Access control for LAN clients ─────────────────────
acl localnet src 10.0.10.0/24
http_access allow localnet
http_access allow localhost

# Block bad port use
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Catch-all deny
http_access deny all

### ── Logging & Hardening ────────────────────────────────
access_log stdio:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
via off
forwarded_for off
