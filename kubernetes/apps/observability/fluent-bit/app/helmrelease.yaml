---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/source.toolkit.fluxcd.io/ocirepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: OCIRepository
metadata:
  name: fluent-bit
spec:
  interval: 15m
  layerSelector:
    mediaType: application/vnd.cncf.helm.chart.content.v1.tar+gzip
    operation: copy
  ref:
    tag: 0.53.0
  url: oci://ghcr.io/home-operations/charts-mirror/fluent-bit
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluent-bit
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: fluent-bit
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    config:
      ## https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/classic-mode/configuration-file
      service: |
        [SERVICE]
          Daemon        Off
          Flush         {{ .Values.flush }}
          Log_Level     {{ .Values.logLevel }}
          Parsers_File  /fluent-bit/etc/parsers.conf
          Parsers_File  /fluent-bit/etc/conf/custom_parsers.conf
          HTTP_Server   On
          HTTP_Listen   0.0.0.0
          HTTP_Port     {{ .Values.metricsPort }}
          Health_Check  On

      ## https://docs.fluentbit.io/manual/pipeline/inputs
      inputs: |
        [INPUT]
          Name        tail
          Alias       kubernetes
          Path        /var/log/containers/*.log
          Parser      containerd
          Tag         kubernetes.*

      ## https://docs.fluentbit.io/manual/pipeline/filters
      filters: |
        [FILTER]
          Name                    kubernetes
          Alias                   kubernetes
          Match                   kubernetes.*
          Buffer_Size             0
          Merge_Log               On
          Kube_Tag_Prefix         kubernetes.var.log.containers.
          K8S-Logging.Parser      On
          K8S-Logging.Exclude     On
          Namespace_Labels        Off
          Annotations             On

        [FILTER]
          Name    modify
          Match   kubernetes.*
          Add     source  home-cluster

      ## https://docs.fluentbit.io/manual/pipeline/outputs
      outputs: |
        [OUTPUT]
          Name          loki
          Match         kubernetes.*
          Host          loki-headless.observability.svc.cluster.local
          Port          3100
          Uri           /loki/api/v1/push
          Line_Format   json
          Labels        job=fluent-bit,source=$source,namespace=$kubernetes['namespace_name'],pod=$kubernetes['pod_name'],container=$kubernetes['container_name'],host=$kubernetes['host']
